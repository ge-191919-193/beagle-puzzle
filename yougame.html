
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>😉</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Arial", sans-serif;
      background: #fffbe6;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin-top: 20px;
    }
    #cover, #game, #congrats {
      display: none;
      flex-direction: column;
      align-items: center;
    }
    .show {
      display: flex !important;
    }
    #puzzle {
      display: grid;
      gap: 2px;
      margin: 10px;
    }
    .tile {
      width: 100px;
      height: 100px;
      background-size: cover;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    #buttons {
      margin-bottom: 10px;
    }
    button {
      background: #fcae60;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      color: white;
      margin: 5px;
      cursor: pointer;
    }
    #moves {
      margin: 5px;
      font-size: 14px;
      color: #444;
    }
    #messageBubble {
      background: #fff;
      border: 2px dashed #fcae60;
      padding: 10px;
      border-radius: 10px;
      margin: 15px;
      font-size: 16px;
      color: #444;
      max-width: 300px;
    }
    #audioControl {
      position: fixed;
      top: 10px;
      right: 10px;
    }
    #loader {
      font-size: 18px;
      color: #888;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>😉</h1>
  <audio id="bgm" loop autoplay>
    <source src="bgm.mp3" type="audio/mpeg" />
  </audio>
  <button id="audioControl" onclick="toggleAudio()">🔊</button>

  <div id="cover" class="show">
    <img src="tutorial_card.png" width="300" style="margin: 20px" />
    <p>歡迎來到拼圖動物宇宙，每關完成後會有小驚喜喔！</p>
    <button onclick="startGame()">開始挑戰 ▶️</button>
  </div>

  <div id="game">
    <div id="progress"></div>
    <div id="moves">滑動次數：0</div>
    <div id="buttons">
      <button onclick="shuffleTiles()">重新打亂 🔄</button>
    </div>
    <div id="loader">圖片載入中...請稍候 🐾</div>
    <div id="puzzle"></div>
  </div>

  <div id="congrats">
    <img id="animalImg" src="" width="300" />
    <div id="messageBubble"></div>
    <button onclick="nextLevel()">下一關 ▶️</button>
  </div>

  <script>
    const levels = [
      { image: "beagle.png", rows: 3, columns: 3, message: "汪汪～你找到我了！好厲害～🐶" },
      { image: "mouse.png", rows: 4, columns: 4, message: "吱吱！居然找到我～太準啦！🐭" },
      { image: "hedgehog.png", rows: 4, columns: 4, message: "刺刺的我也被發現啦～好靈喔！🦔" },
      { image: "owl.png", rows: 5, columns: 5, message: "咕咕～你是最厲害的觀察大師🦉" }
    ];

    let currentLevel = 0, moves = 0, positions = [], emptyIndex = 0;

    const puzzle = document.getElementById("puzzle");
    const cover = document.getElementById("cover");
    const game = document.getElementById("game");
    const congrats = document.getElementById("congrats");
    const animalImg = document.getElementById("animalImg");
    const messageBubble = document.getElementById("messageBubble");
    const movesDisplay = document.getElementById("moves");
    const loader = document.getElementById("loader");
    const progress = document.getElementById("progress");

    function startGame() {
      cover.classList.remove("show");
      game.classList.add("show");
      loadLevel(currentLevel);
    }

    function loadLevel(levelIndex) {
      const { image, rows, columns } = levels[levelIndex];
      progress.textContent = `第 ${levelIndex + 1} 關 / 共 ${levels.length} 關`;
      puzzle.style.gridTemplateColumns = `repeat(${columns}, 100px)`;
      puzzle.style.gridTemplateRows = `repeat(${rows}, 100px)`;
      const total = rows * columns;
      positions = [...Array(total).keys()];
      shuffle(positions);
      emptyIndex = positions.indexOf(total - 1);
      moves = 0;
      updateMoves();
      loader.style.display = "block";
      const img = new Image();
      img.onload = () => {
        loader.style.display = "none";
        render(image, columns);
      };
      img.src = image;
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function shuffleTiles() {
      shuffle(positions);
      emptyIndex = positions.indexOf(positions.length - 1);
      moves = 0;
      updateMoves();
      render(levels[currentLevel].image, levels[currentLevel].columns);
    }

    function updateMoves() {
      movesDisplay.textContent = "滑動次數：" + moves;
    }

    function render(image, columns) {
      puzzle.innerHTML = "";
      positions.forEach((pos, i) => {
        if (pos === positions.length - 1) {
          const blank = document.createElement("div");
          blank.className = "tile";
          blank.style.visibility = "hidden";
          puzzle.appendChild(blank);
        } else {
          const tile = document.createElement("div");
          tile.className = "tile";
          const x = pos % columns;
          const y = Math.floor(pos / columns);
          tile.style.backgroundImage = `url('${image}')`;
          tile.style.backgroundPosition = `-${x * 100}px -${y * 100}px`;
          tile.onclick = () => move(i);
          puzzle.appendChild(tile);
        }
      });
    }

    function move(i) {
      const { columns } = levels[currentLevel];
      const valid = [emptyIndex - 1, emptyIndex + 1, emptyIndex - columns, emptyIndex + columns];
      if (valid.includes(i)) {
        [positions[i], positions[emptyIndex]] = [positions[emptyIndex], positions[i]];
        emptyIndex = i;
        moves++;
        updateMoves();
        render(levels[currentLevel].image, columns);
        checkWin();
      }
    }

    function checkWin() {
      if (positions.every((v, i) => v === i)) {
        game.classList.remove("show");
        congrats.classList.add("show");
        animalImg.src = levels[currentLevel].image;
        messageBubble.textContent = levels[currentLevel].message;
      }
    }

    function nextLevel() {
      currentLevel++;
      if (currentLevel >= levels.length) {
        alert("🎉 全部完成囉～你太強啦！");
        location.reload();
        return;
      }
      congrats.classList.remove("show");
      game.classList.add("show");
      loadLevel(currentLevel);
    }

    function toggleAudio() {
      const bgm = document.getElementById("bgm");
      const btn = document.getElementById("audioControl");
      if (bgm.paused) {
        bgm.play();
        btn.textContent = "🔊";
      } else {
        bgm.pause();
        btn.textContent = "🔈";
      }
    }

    // T鍵作弊測試
    document.addEventListener("keydown", (e) => {
      if (e.key === "t" || e.key === "T") checkWin();
    });
  </script>
</body>
</html>
